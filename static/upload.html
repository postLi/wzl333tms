<!DOCTYPE HTML>
<html>
<head>
<meta charset="UTF-8">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="apple-touch-fullscreen" content="YES" />
<meta name="format-detection" content="telephone=no" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />
<meta http-equiv="Expires" content="-1" />
<meta http-equiv="pragram" content="no-cache" />
<meta name="viewport" content="width=640, user-scalable=no, target-densitydpi=device-dpi">
<meta name="screen-orientation" content="portrait">
<meta name="x5-orientation" content="portrait">
<meta name="full-screen" content="yes">
<meta name="x5-fullscreen" content="true">
<title>上传图片 - 安发中国</title>
<style>
#preview{
  max-width: 100%;
  max-height: 100%;
}
.submitbtn{
  cursor: pointer;
  width: 100px;
  height: 50px;
  background: darkred;
  border: 1px solid #666;
  color: #fff;
  text-align: center;
  line-height: 50px;
  position: fixed;
  bottom: 10px;
  left: 50%;
  margin-left: -50px;
}
.uploadbox{
  display: none;
}
.submitbtn{
  display: none;
}
#loginfo{
  position: fixed;
  width: 50%;
  height: 100%;
  top: 0;
  right: 0;
  background: rgba(0,0,0,.4);
  color: #fff;
  pointer-events: none;
}
</style>
</head>
<body>
  <div class="loadinginfo">正在初始化中...</div>
  <div class="uploadbox">
    <input type="file" id="getimg3"  accept="image/*" >
    <img src="about:blank" id="preview" alt="">
  </div>
  <div class="submitbtn">确认</div>
  <div id="loginfo"></div>
  <script src="js/lrz.all.bundle.js"></script>
  <script src="https://cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
  <script>
/**
 *
 * 　　 ┏┓　 ┏┓
 * 　　┏┛┻━━━┛┻┓
 * 　　┃　　　　　┃
 * 　　┃　　　━　 ┃
 * 　　┃　┳┛　┗┳　┃
 * 　　┃　　　　　 ┃
 * 　　┃　　　┻　　┃
 * 　　┃　　　　　 ┃
 * 　　┗━┓　　　┏━┛Code is far away from bug
* 　　　　┃　　　┃    神兽保佑,代码无bug
* 　　　　┃　　　┃
* 　　　　┃　　　┗━━━┓
* 　　　　┃　　　　　 ┣┓
* 　　　　┃　　　　 ┏┛
* 　　　　┗┓┓┏━┳┓┏┛
* 　　　　　┃┫┫　┃┫┫
* 　　　　　┗┻┛　┗┻┛
 *
 */

  var getParams = function(_keystr,url) {
    var keystr = _keystr || '';
    var args = url || location.search;
    args = args.replace(/&amp;/ig,"&");
    if(!args){return "";}
    var reg = new RegExp('[\?&]' + keystr + '=([^&]*)[&$]?', 'i');
    var chk = args.match(reg);
    return chk ? chk[1] : "";
  };

  function loginfo(str){
    $('#loginfo').append(str + '<br>');
  }
  
 /*  function $(selector){
    return document.querySelectorAll(selector);
  } */
  function getImageFile(e){
    //e.dataTransfer 为拖拉文件时候触发
    var files = e.target.files || e.dataTransfer.files;
    if (!files.length) return;

    // 1024 你懂的^.^
    lrz(files[0],{
      width: 1024
    }).then(function(rst){
      loginfo('=====文件信息=====')
      for(var i in rst.file){
        loginfo(i +' : '+ rst.file[i])
      }
      // 拍照后的文件没有名称，默认为jpg格式即可
      var name = rst.file.name;
      name = !name ? Math.random()+'.jpg' : name;
      // 表单域 file 必须为最后一个表单域；
      var form = new FormData();
      var url = PAGE.data.policydata.host;
      var type = name.match(/([^\.]+)$/);
      type = type ? '.' + type[1] : ''
      
      var updata = {
        key: PAGE.data.policydata.dir + ( +new Date()) + type,
        success_action_status: '201',
        'OSSAccessKeyId': PAGE.data.policydata.accessid,
        'policy': PAGE.data.policydata.policy,
        'signature': PAGE.data.policydata.signature
      }
      form.append('key',updata.key);
      form.append('success_action_status', '201');
      form.append('OSSAccessKeyId', PAGE.data.policydata.accessid);
      form.append('policy', PAGE.data.policydata.policy);
      form.append('signature', PAGE.data.policydata.signature);
      form.append('file', rst.file);
      // form.append('dir', PAGE.data.policydata.dir);
      loginfo('====准备上传，上传信息====')
      for(var j in updata){
        loginfo(j +' : '+ updata[j])
      }
      loginfo('=====发起上传请求====')
      $.ajax({
        url: url,
        method: 'POST',
        // 如果用jq，必须设置以下三项，避免jq 的中间处理
        processData:false,
        cache: false,
        contentType: false,

        headers: {
          // 主动设置Content-Type为multipart/form-data时，会丢掉boundary值，导致后台无法解析数据。
          // 'Content-Type': 'multipart/form-data',
        },
        data: form
      }).done(function(res){
        var url = $(res).find('Location').text();
        if(url){
          loginfo('======上传完成===')
          loginfo('链接：' + url)
          $("#preview")[0].src = url;
          PAGE.data.upurl = url;
          $('.submitbtn').show();
        } else {
          loginfo('4444')
        }
        
      }).fail(function(err){
        showFailPage(JSON.stringify(err))
      });
      
    }).always(function () {
      // 清空文件上传控件的值
      e.target.value = null;
    });
  }

  $('#getimg3')[0].onchange = getImageFile;
  var apiurl = '/api';

  $('.submitbtn').on('click', function(){
    $.post(apiurl + '/tmspluginservice/common/qrcode/v1/SaveByID?access_token='+PAGE.data.token+'&k=' + PAGE.data.id + '&v=' + encodeURIComponent(PAGE.data.upurl)).done(function(res){
      if(res.status === 200){
        showSuccessPage();
      } else {
        loginfo('=======提交信息失败====')
        loginfo(JSON.stringify(res));
      }
      
    }).fail(function(err){
      alert('提交信息出错了')
      showFailPage(JSON.stringify(err))
    })
  });

  var PAGE = {
    data:{}
  };

  function showSuccessPage(){
    $('body').html('<h1>已上传成功。</h1>');
  }

  function showFailPage(str){
    str = str||''
    $('body').html(str + '<h1>请重新扫描二维码上传。</h1>');
  }

  window.onerror = function(){
    showFailPage(JSON.stringify(arguments))
  }

 // 尝试读取3次，如果3次后都没拿到数据，则提示失败
 var requestTime = 0
  function getPolicy(){
    if(requestTime<3){
      requestTime++;
    } else {
      return false;
    }
    $.get(apiurl + '/anfacommonservice/common/oss/v1/policy?access_token='+PAGE.data.token).done(function(res){
      var data = res.data;
      if(res.status === 200){
        PAGE.data.policydata = data
        $('.loadinginfo').hide();
        $('.uploadbox').show();
      } else {
        if(requestTime<3){
          getPolicy();
        } else {
          showFailPage(JSON.stringify(res.errorInfo))
        }
      }
    }).fail(function(err){
      if(requestTime<3){
          getPolicy();
        } else {
          alert('token信息出错了')
          showFailPage(JSON.stringify(err))
        }
    })
  }

  function initPage(){
    // 1.拿取token
    // 2.拿取上传id
    // 3.拿取上传图片张数的按钮，不传则为1
    PAGE.data = {
      token: getParams('access_token'),
      id: getParams('id'),
      len: parseInt(getParams('len'),10) || 1
    }
    if(getParams('page') && getParams('page')==='success'){
      showSuccessPage();
    }else if(!PAGE.data.token || !PAGE.data.id){
      alert('缺少必要参数！');
      showFailPage()
    } else {
      getPolicy()
    }
  }

  initPage();

  </script>
</body>
</html>